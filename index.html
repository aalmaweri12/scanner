<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRZ & PDF417 Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background-color: #f5f5f5; }
        .scanner-container { display: none; }
        .video-container { position: relative; width: 100%; max-width: 600px; margin: 0 auto; }
        video { width: 100%; max-width: 600px; border: 2px solid #333; display: block; }
        canvas { display: none; }
        #scan-region { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); width: 92%; height: 20%; border: 3px solid red; }
        #scan-region.detected { border-color: #00cc00; }
        #result { margin-top: 20px; font-size: 16px; font-weight: bold; padding: 10px; background-color: #fff; border-radius: 5px; }
        .controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        button { padding: 12px 24px; font-size: 16px; background-color: #4285f4; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #3367d6; }
        .scanner-toggle { margin-bottom: 20px; }
    </style>
</head>
<body>

    <h2>MRZ & PDF417 Scanner</h2>

    <div class="scanner-toggle">
        <button onclick="toggleScanner('mrz')">MRZ Scanner</button>
        <button onclick="toggleScanner('pdf417')">PDF417 Scanner</button>
    </div>

    <!-- MRZ Scanner -->
    <div id="mrz-scanner" class="scanner-container">
        <h3>MRZ Scanner</h3>
        <p>Align the MRZ within the scanning area and click "Capture MRZ"</p>
        <div class="video-container">
            <video id="mrz-video" autoplay playsinline></video>
            <div id="scan-region"></div>
        </div>
        <div class="controls">
            <button id="startMrzButton" onclick="startMRZScanning()">Start Camera</button>
            <button id="captureMrzButton" onclick="captureAndProcessMRZ()" disabled>Capture MRZ</button>
        </div>
        <p id="mrz-result">Waiting for scan...</p>
        <img id="debug-mrz-image" alt="Processed Image" />
    </div>

    <!-- PDF417 Scanner -->
    <div id="pdf417-scanner" class="scanner-container">
        <h3>PDF417 Scanner</h3>
        <p>Position the PDF417 barcode within the scanning area</p>
        <div class="video-container">
            <video id="pdf417-video" autoplay playsinline></video>
        </div>
        <button id="startPdf417Button" onclick="startPDF417Scan()">Start Scan</button>
        <p id="pdf417-result">Scan a PDF417 barcode...</p>
    </div>

    <script>
        let activeScanner = null;
        function toggleScanner(scannerType) {
            document.getElementById("mrz-scanner").style.display = (scannerType === 'mrz') ? "block" : "none";
            document.getElementById("pdf417-scanner").style.display = (scannerType === 'pdf417') ? "block" : "none";
            activeScanner = scannerType;
        }

        // MRZ Scanner Variables
        let mrzVideo = document.getElementById('mrz-video');
        let mrzResultText = document.getElementById('mrz-result');
        let scanRegion = document.getElementById('scan-region');
        let startMrzButton = document.getElementById('startMrzButton');
        let captureMrzButton = document.getElementById('captureMrzButton');
        let debugMrzImage = document.getElementById('debug-mrz-image');

        let mrzCanvas = document.createElement('canvas');
        let mrzCtx = mrzCanvas.getContext('2d');
        let mrzVideoStream = null;

        async function startMRZScanning() {
            try {
                mrzResultText.innerText = "Accessing camera...";
                const constraints = { video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } };
                mrzVideoStream = await navigator.mediaDevices.getUserMedia(constraints);
                mrzVideo.srcObject = mrzVideoStream;
                mrzVideo.onloadedmetadata = () => {
                    mrzCanvas.width = mrzVideo.videoWidth;
                    mrzCanvas.height = mrzVideo.videoHeight;
                    mrzResultText.innerText = "Camera ready. Position MRZ and tap 'Capture MRZ'";
                    captureMrzButton.disabled = false;
                };
            } catch (error) {
                console.error("Error starting camera:", error);
                mrzResultText.innerText = "Camera access denied!";
            }
        }

        async function captureAndProcessMRZ() {
            try {
                captureMrzButton.disabled = true;
                mrzResultText.innerText = "Processing MRZ...";
                mrzCtx.drawImage(mrzVideo, 0, 0, mrzCanvas.width, mrzCanvas.height);
                debugMrzImage.src = mrzCanvas.toDataURL();
                debugMrzImage.style.display = "block";

                const { data } = await Tesseract.recognize(mrzCanvas, 'eng', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
                    tessedit_pageseg_mode: 6
                });

                let mrzText = data.text.trim();
                mrzText = mrzText.replace(/L/g, '<').replace(/K/g, '<').replace(/\|/g, '<').replace(/\s+/g, '');
                if (mrzText.length > 20 && mrzText.includes('<')) {
                    scanRegion.classList.add("detected");
                    mrzResultText.innerText = `MRZ Detected:\n${mrzText}`;
                } else {
                    mrzResultText.innerText = "No valid MRZ detected. Please try again.";
                }
            } catch (error) {
                console.error("Error processing image:", error);
                mrzResultText.innerText = "Error processing image. Please try again.";
            } finally {
                captureMrzButton.disabled = false;
            }
        }

        // PDF417 Scanner
        let pdf417Video = document.getElementById('pdf417-video');
        let pdf417ResultText = document.getElementById('pdf417-result');
        let startPdf417Button = document.getElementById('startPdf417Button');
        let selectedDeviceId = null;
        const pdf417Reader = new ZXing.BrowserMultiFormatReader();

        async function startPDF417Scan() {
            try {
                startPdf417Button.disabled = true;
                startPdf417Button.textContent = "Scanning...";
                pdf417ResultText.innerText = "Looking for PDF417 barcode...";
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                if (videoDevices.length > 1) {
                    selectedDeviceId = videoDevices.find(device => device.label.toLowerCase().includes('back'))?.deviceId || videoDevices[0].deviceId;
                } else if (videoDevices.length === 1) {
                    selectedDeviceId = videoDevices[0].deviceId;
                } else {
                    pdf417ResultText.innerText = "No camera found!";
                    startPdf417Button.disabled = false;
                    return;
                }

                pdf417Reader.decodeFromInputVideoDevice(selectedDeviceId, pdf417Video, (result, err) => {
                    if (result) {
                        pdf417ResultText.innerText = "PDF417 Scanned: " + result.getText();
                    }
                });
            } catch (error) {
                console.error("Error starting scan:", error);
                pdf417ResultText.innerText = "Camera access denied!";
                startPdf417Button.disabled = false;
            }
        }
    </script>

</body>
</html>
